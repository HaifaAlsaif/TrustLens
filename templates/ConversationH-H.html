
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, width=device-width">
  <title>Human ↔ Human Conversation • TrustLens</title>

  <style>
    :root{
  --bg:#ffffff;
  --text:#0a0a0a;
  --muted:#717182;
  --line:rgba(0,0,0,.10);
  --primary1:#00B8DB;
  --primary2:#155DFC;
  --radius:14px;
  --success:#0A7A39;
  --danger:#B42318;
  --max-chars:500;
}
[data-theme="dark"]{
  --bg:#0b1220;
  --text:#f1f5f9;
  --muted:#94a3b8;
  --line:rgba(255,255,255,.08);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
  line-height:1.45;
  transition:background .25s,color .25s;
}

/* ---------- Header ---------- */
.mast{
  position:sticky;
  top:0;
  left:0;
  right:0;
  height:64px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding-inline:clamp(16px,6vw,134.8px);
  background:rgba(255,255,255,.85);
  backdrop-filter:saturate(180%) blur(14px);
  border-bottom:1px solid var(--line);
  z-index:1000;
}
[data-theme="dark"] .mast{background:rgba(11,18,32,.85)}
.brand{display:flex;align-items:center;gap:10px;cursor:pointer}
.brand img{width:32px;height:32px}
.brand-name{
  font-size:20px;font-weight:600;
  background:linear-gradient(90deg,var(--primary1),var(--primary2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}

/* --- Lang + Dark --- */
.mast-tools{display:flex;align-items:center;gap:12px;font-size:14px}
.lang-btn,.theme-btn{
  width:36px;height:36px;border-radius:8px;border:none;
  background:var(--line);color:var(--text);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.lang-btn:hover,.theme-btn:hover{background:rgba(0,184,219,.15)}
.theme-btn svg{width:18px;height:18px;fill:currentColor}

/* --- User Profile --- */
.user-profile{position:relative;display:flex;align-items:center;gap:8px;cursor:pointer}
.user-avatar{
  width:40px;height:40px;border-radius:50%;
  background:linear-gradient(135deg,var(--primary1),var(--primary2));
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-size:16px;font-weight:400;
}
.user-info h3{margin:0;font-size:14px;font-weight:400;color:var(--text)}
.user-info p{margin:0;font-size:12px;color:var(--muted);text-transform:capitalize}

/* --- Dropdown --- */
.user-dropdown{
  position:absolute;top:calc(100% + 8px);right:0;
  width:200px;background:var(--bg);border:0.8px solid var(--line);
  border-radius:var(--radius);box-shadow:0 10px 15px -3px rgba(0,0,0,.08);
  display:none;flex-direction:column;z-index:1010;
}
.user-dropdown.show{display:flex}
.dropdown-item{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  font-size:14px;color:var(--text);text-decoration:none;
}
.dropdown-item:hover{background:rgba(0,184,219,.08)}
.dropdown-icon{width:16px;height:16px}
.dropdown-divider{height:1px;background:var(--line);margin:4px 0}

/* ---------- Page Wrapper ---------- */
.page{
  min-height:100vh;
  background:linear-gradient(135deg,#f8fafc,#eff6ff 50%,#ecfeff);
  display:flex;flex-direction:column;
}
[data-theme="dark"] .page{
  background:linear-gradient(135deg,#0b1220,#1e293b 50%,#0f172a)
}
.content-wrapper{
  flex:1;
  display:flex;align-items:center;justify-content:center;
  padding:24px clamp(16px,6vw,134.8px) 40px;
}

/* ---------- Card ---------- */
.card{
  width:100%;max-width:800px;
  border:0.8px solid var(--line);border-radius:var(--radius);
  background:rgba(255,255,255,.98);
  display:flex;flex-direction:column;gap:24px;
  padding:24px;
  box-shadow:0 20px 25px -5px rgba(0,0,0,.1);
  max-height:95vh;
}
[data-theme="dark"] .card{background:rgba(11,18,32,.95)}

/* --- Top Bar  --- */
.top-bar{
  display:flex;align-items:center;gap:12px;
  padding:12px 0;margin:0 -24px 24px -24px;
  border-bottom:0.8px solid var(--line);
  background:transparent;
  font-size:14px;
}
.back-btn{
  display:flex;align-items:center;gap:6px;
  color:var(--text);text-decoration:none;
  padding:6px 10px;border-radius:8px;
  transition:background .18s ease;
}
.back-btn:hover{background:rgba(0,0,0,.04)}
[data-theme="dark"] .back-btn:hover{background:rgba(255,255,255,.04)}
.back-btn svg{
  width:16px;height:16px;stroke:var(--muted);
  stroke-width:2;fill:none;
}
.top-bar-titles{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}
.main-title{
  font-size:16px;
  font-weight:600;
  color:var(--text);
  max-width:70%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.sub-title{
  font-size:13px;
  color:var(--muted);
}
.turn-badge{
  background:rgba(0,184,219,.08);
  color:#007595;
  border:0.8px solid rgba(0,184,219,.25);
  padding:4px 10px;border-radius:8px;
  font-size:12px;font-weight:500;
}

/* --- Messages --- */
.messages{
  flex:1;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:16px;
  padding-right:4px;
  max-height:55vh;
  scrollbar-width:thin;
  scrollbar-color:var(--primary2) transparent;
}
.messages::-webkit-scrollbar{
  width:8px;
}
.messages::-webkit-scrollbar-track{
  background:transparent;
}
.messages::-webkit-scrollbar-thumb{
  background:linear-gradient(180deg,var(--primary1),var(--primary2));
  border-radius:4px;
}
.messages::-webkit-scrollbar-thumb:hover{
  background:var(--primary2);
}

.msg{
  display:flex;
  gap:12px;
  font-size:14px;
}
.msg.you{flex-direction:row-reverse}
.msg.peer{flex-direction:row}

.avatar{
  width:40px;height:40px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-weight:600;font-size:16px;
}
.msg.you .avatar{
  background:linear-gradient(135deg,var(--primary1),var(--primary2));
  color:#fff;
}
.msg.peer .avatar{
  background:#e5e7eb;
  color:#0f172a;
}
[data-theme="dark"] .msg.peer .avatar{
  background:#1f2937;
  color:#e5e7eb;
}

.bubble{
  max-width:80%;
  padding:12px 16px;
  border-radius:16px;
  line-height:1.45;
}
.msg.you .bubble{
  background:linear-gradient(135deg,var(--primary1),var(--primary2));
  color:#fff;border-bottom-right-radius:6px;
}
.msg.peer .bubble{
  background:#f1f5f9;border-bottom-left-radius:6px;color:#0a0a0a;
}
[data-theme="dark"] .msg.peer .bubble{
  background:#111827;color:#e5e7eb;
}

/* --- Input Area --- */
.input-area{border-top:0.8px solid var(--line);padding-top:16px}
.textarea{
  width:100%;min-height:96px;border-radius:8px;
  background:#f3f3f5;border:0.8px solid transparent;
  color:var(--text);padding:10px 12px;resize:vertical;font-size:14px;
}
.textarea:focus{outline:none;border-color:rgba(21,93,252,.45);background:#f9fafb}
.input-footer{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:8px;font-size:12px;color:var(--muted);
}
.send-btn{
  height:36px;border-radius:8px;border:none;
  background:linear-gradient(90deg,var(--primary1),var(--primary2));
  color:#fff;padding:0 16px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:14px;
}
.send-btn:disabled{opacity:.5;cursor:not-allowed}
.char-counter{font-size:12px;color:var(--muted)}
.char-counter.limit{color:var(--danger)}
.completed-box{
  display:none;
  align-items:center;justify-content:center;
  height:96px;border-radius:8px;background:#f1f5f9;
  font-size:14px;color:var(--success);
}
.completed-box.show{display:flex}
  </style>
</head>

<body>
  <div class="page">
    <!-- ================== Header ================== -->
    <header class="mast">
      <div class="brand">
        <img src="../static/images/icon_logo.svg" alt="TrustLens logo">
        <div class="brand-name">TrustLens</div>
      </div>

      <div class="mast-tools">
        <button class="lang-btn" id="langBtn" title="Switch Language">EN</button>
        <button class="theme-btn" id="themeBtn" title="Toggle Theme">
          <svg class="sun" viewBox="0 0 24 24">
             <!-- بغيره بعدين -->
            <path d="M12 17.5a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11zM12 7a4 4 0 1 0 0 8
                     4 4 0 0 0 0-8zM12 4a1 1 0 0 1 1 1v1a1 1 0 0 1-2 0V5
                     a1 1 0 0 1 1-1zM12 18a1 1 0 0 1 1 1v1a1 1 0 0 1-2 0v-1
                     a1 1 0 0 1 1-1zM6.34 6.34a1 1 0 0 1 1.41 0l.7.7
                     a1 1 0 0 1-1.41 1.41l-.7-.7a1 1 0 0 1 0-1.41zM15.54 15.54
                     a1 1 0 0 1 1.41 0l.7.7a1 1 0 0 1-1.41 1.41l-.7-.7
                     a1 1 0 0 1 0-1.41zM4 12a1 1 0 0 1 1-1h1a1 1 0 0 1 0 2H5
                     a1 1 0 0 1-1-1zM18 12a1 1 0 0 1 1-1h1a1 1 0 0 1 0 2h-1
                     a1 1 0 0 1-1-1zM6.34 17.66a1 1 0 0 1 0-1.41l.7-.7
                     a1 1 0 1 1 1.41 1.41l-.7.7a1 1 0 0 1-1.41 0zM15.54 8.46
                     a1 1 0 0 1 0-1.41l.7-.7a1 1 0 1 1 1.41 1.41l-.7.7
                     a1 1 0 0 1 0-1.41z"/>
          </svg>
          <svg class="moon" viewBox="0 0 24 24" style="display:none">
            <path d="M21.64 13a1 1 0 0 0-1.05-.14 8.05 8.05 0 0 1-3.37.73
                     8.15 8.15 0 0 1-8.14-8.1 8.59 8.59 0 0 1 .25-2
                     A1 1 0 0 0 8 2.36a10.14 10.14 0 1 0 14 11.28
                     1 1 0 0 0-.36-1.64z"/>
          </svg>
        </button>

        <div class="user-profile" id="userProfile">
          <div class="user-avatar">{{ user_name[0]|upper }}</div>
          <div class="user-info">
            <h3>{{ user_name }}</h3>
            <p>examiner</p>
          </div>
          <div class="user-dropdown" id="userDropdown">
            <a href="OwnerHome.html" class="dropdown-item">
              <img src="../static/images/img_iconhome.svg" alt="Home" class="dropdown-icon"> Home
            </a>
            <div class="dropdown-divider"></div>
            <a href="OwnerProfile.html" class="dropdown-item">
              <img src="../static/images/img_profile.svg" alt="Profile" class="dropdown-icon"> Profile
            </a>
            <a href="Settings.html" class="dropdown-item">
              <img src="../static/images/img_icon_Settings.svg" alt="Settings" class="dropdown-icon"> Settings
            </a>
            <div class="dropdown-divider"></div>
            <a href="index.html" class="dropdown-item">
              <img src="../static/images/img_logout.png" alt="Logout" class="dropdown-icon"> Logout
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- ================== Content ================== -->
    <div class="content-wrapper">
      <section class="card">
        <!-- ========== Top Bar ========== -->
        <div class="top-bar">
            <a class="back-btn" href="/projectdetailsexaminer/{{ project_id }}">

            <svg width="16" height="16" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span>Back to Project</span>
          </a>

          <div class="top-bar-titles">
            <div class="main-title">{{ task_title }}</div>
            <div class="sub-title">Human ↔ Human Conversation</div>
          </div>

          <div class="turn-badge">
            Turn <span id="turnNo">0</span> /
            <span id="maxTurns">{{ max_turns }}</span>
          </div>
        </div>

        <!-- ========== Messages Area ========== -->
        <div class="messages" id="messages">
          <!-- في Human ↔ Human الرسائل تجه من الـ API -->
        </div>

        <!-- ========== Input ========== -->
        <div class="input-area" id="inputArea">
          <textarea class="textarea" id="userInput"
                    placeholder="Type your message here..."></textarea>
          <div class="input-footer">
            <span class="char-counter" id="charCounter">0 / 500</span>
            <button class="send-btn" id="sendBtn">Send Message</button>
          </div>
        </div>

        <!-- ========== Completed State ========== -->
        <div class="completed-box" id="completedBox">
          Task Completed – Maximum turns reached.
        </div>
      </section>
    </div>
  </div>
  <script>
    /* =========================================================
                   User menu (profile dropdown)
     ========================================================= */
const userProfile = document.getElementById('userProfile');
const userDropdown = document.getElementById('userDropdown');

userProfile.addEventListener('click', () => {
  userDropdown.classList.toggle('show');
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('#userProfile')) {
    userDropdown.classList.remove('show');
  }
});

/* =========================================================
                Theme toggle (light / dark)
========================================================= */
const themeBtn = document.getElementById('themeBtn');
const html = document.documentElement;

themeBtn.addEventListener('click', () => {
  const current = html.getAttribute('data-theme') || 'light';
  const next = current === 'light' ? 'dark' : 'light';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  themeBtn.querySelector('.sun').style.display  = next === 'light' ? 'block' : 'none';
  themeBtn.querySelector('.moon').style.display = next === 'dark'  ? 'block' : 'none';
});

(function initTheme() {
  const saved = localStorage.getItem('theme') || 'light';
  html.setAttribute('data-theme', saved);
  themeBtn.querySelector('.sun').style.display  = saved === 'light' ? 'block' : 'none';
  themeBtn.querySelector('.moon').style.display = saved === 'dark'  ? 'block' : 'none';
})();

/* =========================================================
   Language toggle (EN / AR) – واجهة فقط
========================================================= */
const langBtn = document.getElementById('langBtn');

langBtn.addEventListener('click', () => {
  const current = langBtn.textContent.trim();
  const next = current === 'EN' ? 'AR' : 'EN';
  langBtn.textContent = next;
  localStorage.setItem('lang', next);
});

(function initLang() {
  const saved = localStorage.getItem('lang') || 'EN';
  langBtn.textContent = saved;
})();

/* =========================================================
   Chat state, character counter & API communication
========================================================= */
const userInput    = document.getElementById('userInput');
const charCounter  = document.getElementById('charCounter');
const sendBtn      = document.getElementById('sendBtn');
const inputArea    = document.getElementById('inputArea');
const completedBox = document.getElementById('completedBox');
const messagesEl   = document.getElementById('messages');
const turnNo       = document.getElementById('turnNo');

const MAX_CHARS = 500;

// نقرأ الحد الأقصى لل turns من الـ HTML
const maxTurnsSpan = document.getElementById('maxTurns');
const MAX_TURNS = maxTurnsSpan
  ? parseInt(maxTurnsSpan.textContent, 10) || 6
  : 6;

// نبدأ من 0
let currentTurn = 0;
turnNo.textContent = currentTurn;

// أول حرف من اسم الليوزر
const CURRENT_USER_INITIAL = "{{ user_name[0]|upper }}";

// مسارات Human ↔ Human APIs (هذي نبرمجها في Flask)
const HH_MESSAGES_URL = '/api/hh/messages';
const HH_SEND_URL     = '/api/hh/send';

// taskId من الباك
const TASK_ID = "{{ task_id or '' }}";

// تحديث عداد الأحرف
function updateCounter() {
  const len = userInput.value.length;
  charCounter.textContent = `${len} / ${MAX_CHARS}`;
  charCounter.classList.toggle('limit', len >= MAX_CHARS);
  sendBtn.disabled = len === 0 || len > MAX_CHARS || userInput.disabled;
}

userInput.addEventListener('input', updateCounter);
updateCounter();

// قفل الإدخال
function lockInput() {
  userInput.value    = '';
  userInput.disabled = true;
  sendBtn.disabled   = true;
  inputArea.style.display = 'none';
  completedBox.classList.add('show');
}

/**
 * رسم رسالة واحدة
 * msg: { text, side: 'you' | 'peer', authorInitial? }
 */
function renderSingleMessage(msg) {
  const side = msg.side === 'you' ? 'you' : 'peer';
  const text = msg.text || '';
  const initial = msg.authorInitial || (side === 'you' ? CURRENT_USER_INITIAL : '?');

  const row = document.createElement('div');
  row.className = `msg ${side}`;

  row.innerHTML = `
    <div class="avatar">${initial}</div>
    <div class="bubble"></div>
  `;

  const bubbleEl = row.querySelector('.bubble');
  bubbleEl.textContent = text;

  messagesEl.appendChild(row);
}

/**
 * إعادة رسم جميع الرسائل القادمة من السيرفر
 */
function renderMessages(list, serverTurn) {
  messagesEl.innerHTML = '';
  (list || []).forEach(m => renderSingleMessage(m));

  messagesEl.scrollTop = messagesEl.scrollHeight;

  if (typeof serverTurn === 'number') {
    currentTurn = serverTurn;
  } else {
    currentTurn = (list || []).filter(m => m.side === 'you').length;
  }

  turnNo.textContent = currentTurn;

  if (currentTurn >= MAX_TURNS) {
    lockInput();
  }
}

/**
 * تحميل الرسائل من السيرفر
 */
async function loadMessages() {
  if (!TASK_ID) {
    // بدون taskId لن نتصل بالباك
    return;
  }

  try {
    const url = HH_MESSAGES_URL + '?taskId=' + encodeURIComponent(TASK_ID);
    const res = await fetch(url, { method: 'GET' });

    if (!res.ok) {
      console.error('Failed to load HH messages. Status:', res.status);
      return;
    }

    const data = await res.json();
    const msgs = data.messages || [];
    const serverTurn = typeof data.currentTurn === 'number'
      ? data.currentTurn
      : undefined;

    renderMessages(msgs, serverTurn);
  } catch (err) {
    console.error('Network error while loading HH messages:', err);
  }
}

/**
 * إرسال رسالة جديدة
 */
async function sendMsg() {
  const txt = userInput.value.trim();
  if (!txt || userInput.disabled) return;

  if (!TASK_ID) {
    alert('Missing taskId – Human ↔ Human API needs a valid task.');
    return;
  }

  sendBtn.disabled = true;
  sendBtn.textContent = 'Sending...';

  try {
    const payload = {
      taskId: TASK_ID,
      text: txt
    };

    const res = await fetch(HH_SEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      console.error('HH send error:', data);
      alert(data.error || 'Failed to send message.');
      return;
    }

    userInput.value = '';
    updateCounter();
    await loadMessages();
  } catch (err) {
    console.error('Network error while sending HH message:', err);
    alert('Network error while sending the message. Please try again.');
  } finally {
    if (!userInput.disabled) {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send Message';
    }
  }
}

// زر الإرسال
sendBtn.addEventListener('click', sendMsg);

// Ctrl + Enter
userInput.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    sendMsg();
  }
});

// تحميل أولي
loadMessages();

// تحديث دوري كل 4 ثواني (لو في taskId ولسّا ما انتهت التيرنز)
setInterval(() => {
  if (!userInput.disabled && TASK_ID) {
    loadMessages();
  }
}, 4000);
  </script>
</body>
</html>
